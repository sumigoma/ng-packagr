{"version":3,"file":"rollup.js","sourceRoot":"","sources":["../../../src/lib/steps/rollup.ts"],"names":[],"mappings":"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","sourcesContent":["import * as  __rollup from 'rollup';\nimport * as nodeResolve from 'rollup-plugin-node-resolve';\nimport * as commonJs from 'rollup-plugin-commonjs';\nimport * as path from 'path';\nimport * as log from '../util/log';\nimport { BuildStep } from '../deprecations';\n\nexport type BundleFormat = __rollup.Format;\n\nexport interface RollupOptions {\n  moduleName: string,\n  entry: string,\n  format: BundleFormat,\n  dest: string,\n  umdModuleIds?: { [key: string]: string },\n  embedded?: string[]\n}\n\nexport const externalModuleIdStrategy = (moduleId: string, embedded: string[] = []): boolean => {\n  // more information about why we don't check for 'node_modules' path\n  // https://github.com/rollup/rollup-plugin-node-resolve/issues/110#issuecomment-350353632\n  if (\n    path.isAbsolute(moduleId) ||\n    moduleId.startsWith(\".\") ||\n    moduleId.startsWith(\"/\") ||\n    moduleId.indexOf(\"commonjsHelpers\") >= 0 || // in case we are embedding a commonjs module we need to include it's helpers also\n    embedded.some(x => x === moduleId)\n  ) {\n    // if it's either 'absolute', marked to embed, starts with a '.' or '/' it's not external\n    return false;\n  }\n\n  return true;\n}\n\nexport const umdModuleIdStrategy = (moduleId: string, umdModuleIds: { [key: string]: string } = {}): string => {\n  let nameProvided: string | undefined;\n  if (nameProvided = umdModuleIds[moduleId]) {\n    return nameProvided;\n  }\n\n  let regMatch;\n  if (regMatch = /^\\@angular\\/platform-browser-dynamic(\\/?.*)/.exec(moduleId)) {\n    return `ng.platformBrowserDynamic${regMatch[1]}`.replace(\"/\", \".\")\n  }\n\n  if (regMatch = /^\\@angular\\/platform-browser(\\/?.*)/.exec(moduleId)) {\n    return `ng.platformBrowser${regMatch[1]}`.replace(\"/\", \".\")\n  }\n\n  if (regMatch = /^\\@angular\\/(.+)/.exec(moduleId)) {\n    return `ng.${regMatch[1]}`.replace(\"/\", \".\")\n  }\n\n  if (/^rxjs\\/(add\\/)?observable/.test(moduleId)) {\n    return \"Rx.Observable\";\n  }\n\n  if (/^rxjs\\/scheduler/.test(moduleId)) {\n    return \"Rx.Scheduler\";\n  }\n\n  if (/^rxjs\\/symbol/.test(moduleId)) {\n    return \"Rx.Symbol\";\n  }\n\n  if (/^rxjs\\/(add\\/)?operator/.test(moduleId)) {\n    return \"Rx.Observable.prototype\";\n  }\n\n  if (/^rxjs\\/[^\\/]+$/.test(moduleId)) {\n    return \"Rx\";\n  }\n\n  return ''; // leave it up to rollup to guess the global name\n}\n\n/** Runs rollup over the given entry file, writes a bundle file. */\nasync function rollup(opts: RollupOptions): Promise<void> {\n  log.debug(`rollup (v${__rollup.VERSION}) ${opts.entry} to ${opts.dest} (${opts.format})`);\n\n  // Create the bundle\n  const bundle: __rollup.Bundle = await __rollup.rollup({\n    context: 'this',\n    external: moduleId => externalModuleIdStrategy(moduleId, opts.embedded || []),\n    input: opts.entry,\n    plugins: [\n      nodeResolve({ jsnext: true, module: true }),\n      commonJs(),\n    ],\n    onwarn: (warning) => {\n      if (warning.code === 'THIS_IS_UNDEFINED') {\n        return;\n      }\n\n      log.warn(warning.message);\n    }\n  });\n\n  // Output the bundle to disk\n  await bundle.write({\n    name: `${opts.moduleName}`,\n    file: opts.dest,\n    format: opts.format,\n    banner: '',\n    globals: moduleId => umdModuleIdStrategy(moduleId, opts.umdModuleIds || {}),\n    sourcemap: true\n  });\n}\n\nexport const flattenToFesm15: BuildStep =\n  async ({ artefacts, entryPoint, pkg }) => {\n    const fesm15File = path.resolve(artefacts.stageDir, 'esm2015', entryPoint.flatModuleFile + '.js');\n    await rollup({\n      moduleName: entryPoint.moduleId,\n      entry: artefacts.es2015EntryFile,\n      format: 'es',\n      dest: fesm15File,\n      embedded: entryPoint.embedded\n    });\n\n    artefacts.fesm15BundleFile = fesm15File;\n  };\n\nexport const flattenToUmd: BuildStep =\n  async ({ artefacts, entryPoint, pkg }) => {\n    const umdFile = path.resolve(artefacts.stageDir, 'bundles', entryPoint.flatModuleFile + '.umd.js');\n    await rollup({\n      moduleName: entryPoint.umdModuleId,\n      entry: artefacts.fesm5BundleFile,\n      format: 'umd',\n      dest: umdFile,\n      umdModuleIds: {\n        ...entryPoint.umdModuleIds\n      },\n      embedded: entryPoint.embedded\n    });\n\n    artefacts.umdBundleFile = umdFile;\n  };\n"]}